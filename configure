#!/bin/bash

if [ $1 == "--help" ]; then
    echo "This script checks all needed dependencies and allow optional configuration."
    echo ""
    echo "Usage: ./configure [--help] [options]"
    echo "Options:"
    echo "  --user-name     Change the default user name"
    echo "  --internal      Switches to internal build and compile veins completly"
    exit 0
fi

set -eu

echo ""
echo "Checking for HashiCorp Packer (tested with 1.2.1)"
packer --version

echo ""
echo "Checking for Oracle VM VirtualBox (tested with 5.2.8)"
VBoxManage --version

echo ""
echo "Checking for Perl shasum (tested with 5.84)"
shasum --version


pararser() {
    # Define default values
    user_name=${user_name:-veins}
    internal=${internal:-false}

    # Assign the values given by the user
    while [ $# -gt 0 ]; do
        if [[ $1 == *"--"* ]]; then
            param="${1/--/}"
            declare -g $param="$2"
        fi
        shift
    done

}

pararser $@


if [ $internal == "true" ]; then
    echo "Internal build"
    sed -i "s/internal: false/internal: true/g" ansible instant-veins.yml
fi

if [ $user_name != "veins" ]; then
echo ""
    # replace user in ansible playbook
	sed -i "s/user: \"veins\"/user: $user_name/g" ansible/instant-veins.yml	
	sed -i "s/\"Veins/\"$user_name/g" ansible/instant-veins.yml
	# replace user in scripts
	sed -i "s/passwd\/username string veins/passwd\/username string $user_name/g" scripts/preseed.cfg
	sed -i "s/veins/$user_name/g" scripts/post.sh
	sed -i "s/veins/$user_name/g" scripts/pre.sh
	# replace user in pkr.hcl file
	sed -i "s/ssh_username         = \"veins\"/ssh_username         = \"$user_name\"/g" instant-veins.pkr.hcl
fi